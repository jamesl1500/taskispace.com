'use client'

import { useState, useRef, useEffect } from 'react'
import { useConversationMessages, useSendMessage } from '@/hooks/useConversations'
import { ConversationMessageWithUser } from '@/types/conversations'
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card'
import { Button } from '@/components/ui/button'
import { Textarea } from '@/components/ui/textarea'
import { Input } from '@/components/ui/input'
import { Skeleton } from '@/components/ui/skeleton'
import { Avatar, AvatarFallback, AvatarImage } from '@/components/ui/avatar'
import { Badge } from '@/components/ui/badge'
import { Send, Loader2, MessageCircle } from 'lucide-react'\nimport { formatDistanceToNow } from 'date-fns'\nimport { toast } from 'sonner'\n\ninterface ConversationMessagesProps {\n  conversationId: string\n}\n\nexport default function ConversationMessages({ conversationId }: ConversationMessagesProps) {\n  const { data: messages, isLoading, error } = useConversationMessages(conversationId)\n  const sendMessage = useSendMessage(conversationId)\n  \n  const [newMessage, setNewMessage] = useState('')\n  const [subject, setSubject] = useState('')\n  const [showSubject, setShowSubject] = useState(false)\n  \n  const messagesEndRef = useRef<HTMLDivElement>(null)\n  const textareaRef = useRef<HTMLTextAreaElement>(null)\n\n  // Auto-scroll to bottom when new messages arrive\n  useEffect(() => {\n    messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' })\n  }, [messages])\n\n  // Auto-resize textarea\n  useEffect(() => {\n    if (textareaRef.current) {\n      textareaRef.current.style.height = 'inherit'\n      textareaRef.current.style.height = `${textareaRef.current.scrollHeight}px`\n    }\n  }, [newMessage])\n\n  const handleSendMessage = async (e: React.FormEvent) => {\n    e.preventDefault()\n    \n    if (!newMessage.trim()) {\n      toast.error('Please enter a message')\n      return\n    }\n\n    try {\n      await sendMessage.mutateAsync({\n        content: newMessage.trim(),\n        subject: subject.trim() || undefined\n      })\n      setNewMessage('')\n      setSubject('')\n      setShowSubject(false)\n    } catch (error) {\n      toast.error('Failed to send message')\n      console.error('Error sending message:', error)\n    }\n  }\n\n  const handleKeyPress = (e: React.KeyboardEvent) => {\n    if (e.key === 'Enter' && !e.shiftKey) {\n      e.preventDefault()\n      handleSendMessage(e as any)\n    }\n  }\n\n  const getInitials = (name: string | undefined, email: string) => {\n    if (name) {\n      return name.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2)\n    }\n    return email.slice(0, 2).toUpperCase()\n  }\n\n  if (isLoading) {\n    return (\n      <Card className=\"h-full flex flex-col\">\n        <CardHeader>\n          <Skeleton className=\"h-6 w-48\" />\n        </CardHeader>\n        <CardContent className=\"flex-1 space-y-4\">\n          {[...Array(5)].map((_, i) => (\n            <div key={i} className=\"flex items-start space-x-3\">\n              <Skeleton className=\"h-10 w-10 rounded-full\" />\n              <div className=\"flex-1 space-y-2\">\n                <Skeleton className=\"h-4 w-24\" />\n                <Skeleton className=\"h-16 w-full\" />\n              </div>\n            </div>\n          ))}\n        </CardContent>\n      </Card>\n    )\n  }\n\n  if (error) {\n    return (\n      <Card className=\"h-full flex items-center justify-center\">\n        <CardContent className=\"text-center\">\n          <p className=\"text-red-500\">Error loading messages</p>\n          <p className=\"text-sm text-muted-foreground mt-2\">{error.message}</p>\n        </CardContent>\n      </Card>\n    )\n  }\n\n  return (\n    <Card className=\"h-full flex flex-col\">\n      <CardHeader>\n        <CardTitle className=\"flex items-center\">\n          <MessageCircle className=\"h-5 w-5 mr-2\" />\n          Messages\n        </CardTitle>\n      </CardHeader>\n      \n      {/* Messages List */}\n      <CardContent className=\"flex-1 overflow-y-auto space-y-4 max-h-96\">\n        {!messages || messages.length === 0 ? (\n          <div className=\"text-center py-8\">\n            <MessageCircle className=\"h-12 w-12 mx-auto text-muted-foreground mb-4\" />\n            <p className=\"text-muted-foreground\">No messages yet. Start the conversation!</p>\n          </div>\n        ) : (\n          <>\n            {messages.map((message) => (\n              <MessageItem key={message.id} message={message} getInitials={getInitials} />\n            ))}\n            <div ref={messagesEndRef} />\n          </>\n        )}\n      </CardContent>\n      \n      {/* Message Input */}\n      <CardContent className=\"border-t pt-4\">\n        <form onSubmit={handleSendMessage} className=\"space-y-3\">\n          {showSubject && (\n            <Input\n              placeholder=\"Subject (optional)\"\n              value={subject}\n              onChange={(e) => setSubject(e.target.value)}\n            />\n          )}\n          <div className=\"flex space-x-2\">\n            <Textarea\n              ref={textareaRef}\n              placeholder=\"Type your message... (Shift+Enter for new line)\"\n              value={newMessage}\n              onChange={(e) => setNewMessage(e.target.value)}\n              onKeyPress={handleKeyPress}\n              className=\"min-h-[60px] max-h-32 resize-none\"\n              rows={2}\n            />\n            <div className=\"flex flex-col space-y-2\">\n              <Button\n                type=\"button\"\n                variant=\"outline\"\n                size=\"sm\"\n                onClick={() => setShowSubject(!showSubject)}\n                className=\"text-xs\"\n              >\n                Subject\n              </Button>\n              <Button \n                type=\"submit\" \n                disabled={sendMessage.isPending || !newMessage.trim()}\n                size=\"sm\"\n              >\n                {sendMessage.isPending ? (\n                  <Loader2 className=\"h-4 w-4 animate-spin\" />\n                ) : (\n                  <Send className=\"h-4 w-4\" />\n                )}\n              </Button>\n            </div>\n          </div>\n        </form>\n      </CardContent>\n    </Card>\n  )\n}\n\ninterface MessageItemProps {\n  message: ConversationMessageWithUser\n  getInitials: (name: string | undefined, email: string) => string\n}\n\nfunction MessageItem({ message, getInitials }: MessageItemProps) {\n  return (\n    <div className=\"flex items-start space-x-3\">\n      <Avatar className=\"h-10 w-10\">\n        <AvatarImage src={message.user.user_metadata?.avatar_url} />\n        <AvatarFallback className=\"bg-primary text-primary-foreground text-sm\">\n          {getInitials(message.user.user_metadata?.full_name, message.user.email)}\n        </AvatarFallback>\n      </Avatar>\n      <div className=\"flex-1 min-w-0\">\n        <div className=\"flex items-center space-x-2 mb-1\">\n          <span className=\"font-medium text-sm\">\n            {message.user.user_metadata?.full_name || message.user.email}\n          </span>\n          <span className=\"text-xs text-muted-foreground\">\n            {formatDistanceToNow(new Date(message.created_at), { addSuffix: true })}\n          </span>\n        </div>\n        \n        {message.subject && (\n          <div className=\"mb-2\">\n            <Badge variant=\"secondary\" className=\"text-xs\">\n              {message.subject}\n            </Badge>\n          </div>\n        )}\n        \n        <div className=\"bg-muted rounded-lg p-3\">\n          <p className=\"text-sm whitespace-pre-wrap\">{message.content}</p>\n        </div>\n        \n        {message.attachments && message.attachments.length > 0 && (\n          <div className=\"mt-2 space-y-1\">\n            {message.attachments.map((attachment) => (\n              <a\n                key={attachment.id}\n                href={attachment.url}\n                className=\"inline-flex items-center text-xs text-primary hover:underline\"\n                target=\"_blank\"\n                rel=\"noopener noreferrer\"\n              >\n                ðŸ“Ž {attachment.name}\n              </a>\n            ))}\n          </div>\n        )}\n      </div>\n    </div>\n  )\n}