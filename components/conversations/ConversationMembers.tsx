'use client'

import { useState } from 'react'\nimport { useConversationMembers, useAddMember, useRemoveMember } from '@/hooks/useConversations'\nimport { ConversationMemberWithUser } from '@/types/conversations'\nimport { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card'\nimport { Button } from '@/components/ui/button'\nimport { Input } from '@/components/ui/input'\nimport { Avatar, AvatarFallback, AvatarImage } from '@/components/ui/avatar'\nimport { Badge } from '@/components/ui/badge'\nimport { Skeleton } from '@/components/ui/skeleton'\nimport {\n  Dialog,\n  DialogContent,\n  DialogDescription,\n  DialogHeader,\n  DialogTitle,\n  DialogTrigger,\n} from '@/components/ui/dialog'\nimport {\n  DropdownMenu,\n  DropdownMenuContent,\n  DropdownMenuItem,\n  DropdownMenuSeparator,\n  DropdownMenuTrigger,\n} from '@/components/ui/dropdown-menu'\nimport { Users, UserPlus, MoreVertical, Crown, User, UserMinus, Loader2 } from 'lucide-react'\nimport { toast } from 'sonner'\nimport { useAuth } from '@/hooks/queries/useAuthQueries'\n\ninterface ConversationMembersProps {\n  conversationId: string\n}\n\nexport default function ConversationMembers({ conversationId }: ConversationMembersProps) {\n  const { user } = useAuth()\n  const { data: members, isLoading, error } = useConversationMembers(conversationId)\n  const addMember = useAddMember(conversationId)\n  const removeMember = useRemoveMember(conversationId)\n  \n  const [showAddDialog, setShowAddDialog] = useState(false)\n  const [newMemberEmail, setNewMemberEmail] = useState('')\n\n  const currentUserMember = members?.find(member => member.user_id === user?.id)\n  const isCurrentUserAdmin = currentUserMember?.role === 'admin'\n\n  const handleAddMember = async (e: React.FormEvent) => {\n    e.preventDefault()\n    \n    if (!newMemberEmail.trim()) {\n      toast.error('Please enter an email address')\n      return\n    }\n\n    try {\n      // Note: In a real implementation, you'd need to look up the user by email first\n      // This is a simplified version\n      toast.info('Member invitation feature coming soon')\n      setShowAddDialog(false)\n      setNewMemberEmail('')\n    } catch (error) {\n      toast.error('Failed to add member')\n      console.error('Error adding member:', error)\n    }\n  }\n\n  const handleRemoveMember = async (memberId: number, memberName: string) => {\n    if (!confirm(`Are you sure you want to remove ${memberName} from this conversation?`)) {\n      return\n    }\n\n    try {\n      await removeMember.mutateAsync(memberId)\n      toast.success('Member removed successfully')\n    } catch (error) {\n      toast.error('Failed to remove member')\n      console.error('Error removing member:', error)\n    }\n  }\n\n  const getInitials = (name: string | undefined, email: string) => {\n    if (name) {\n      return name.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2)\n    }\n    return email.slice(0, 2).toUpperCase()\n  }\n\n  if (isLoading) {\n    return (\n      <Card>\n        <CardHeader>\n          <CardTitle className=\"flex items-center\">\n            <Users className=\"h-5 w-5 mr-2\" />\n            <Skeleton className=\"h-6 w-24\" />\n          </CardTitle>\n        </CardHeader>\n        <CardContent className=\"space-y-3\">\n          {[...Array(3)].map((_, i) => (\n            <div key={i} className=\"flex items-center space-x-3\">\n              <Skeleton className=\"h-10 w-10 rounded-full\" />\n              <div className=\"flex-1 space-y-1\">\n                <Skeleton className=\"h-4 w-32\" />\n                <Skeleton className=\"h-3 w-24\" />\n              </div>\n            </div>\n          ))}\n        </CardContent>\n      </Card>\n    )\n  }\n\n  if (error) {\n    return (\n      <Card>\n        <CardContent className=\"p-6 text-center\">\n          <p className=\"text-red-500\">Error loading members</p>\n          <p className=\"text-sm text-muted-foreground mt-2\">{error.message}</p>\n        </CardContent>\n      </Card>\n    )\n  }\n\n  return (\n    <Card>\n      <CardHeader>\n        <div className=\"flex items-center justify-between\">\n          <CardTitle className=\"flex items-center\">\n            <Users className=\"h-5 w-5 mr-2\" />\n            Members ({members?.length || 0})\n          </CardTitle>\n          {isCurrentUserAdmin && (\n            <Dialog open={showAddDialog} onOpenChange={setShowAddDialog}>\n              <DialogTrigger asChild>\n                <Button variant=\"outline\" size=\"sm\">\n                  <UserPlus className=\"h-4 w-4 mr-2\" />\n                  Add Member\n                </Button>\n              </DialogTrigger>\n              <DialogContent className=\"sm:max-w-md\">\n                <DialogHeader>\n                  <DialogTitle>Add Member</DialogTitle>\n                  <DialogDescription>\n                    Invite someone to join this conversation.\n                  </DialogDescription>\n                </DialogHeader>\n                <form onSubmit={handleAddMember} className=\"space-y-4\">\n                  <Input\n                    type=\"email\"\n                    placeholder=\"Enter email address\"\n                    value={newMemberEmail}\n                    onChange={(e) => setNewMemberEmail(e.target.value)}\n                  />\n                  <div className=\"flex justify-end space-x-2\">\n                    <Button type=\"button\" variant=\"outline\" onClick={() => setShowAddDialog(false)}>\n                      Cancel\n                    </Button>\n                    <Button type=\"submit\" disabled={addMember.isPending}>\n                      {addMember.isPending && (\n                        <Loader2 className=\"h-4 w-4 mr-2 animate-spin\" />\n                      )}\n                      Add Member\n                    </Button>\n                  </div>\n                </form>\n              </DialogContent>\n            </Dialog>\n          )}\n        </div>\n      </CardHeader>\n      <CardContent className=\"space-y-3\">\n        {!members || members.length === 0 ? (\n          <div className=\"text-center py-4\">\n            <Users className=\"h-8 w-8 mx-auto text-muted-foreground mb-2\" />\n            <p className=\"text-sm text-muted-foreground\">No members found</p>\n          </div>\n        ) : (\n          members.map((member) => (\n            <MemberItem\n              key={member.id}\n              member={member}\n              currentUserId={user?.id}\n              isCurrentUserAdmin={isCurrentUserAdmin}\n              onRemove={(memberId, memberName) => handleRemoveMember(memberId, memberName)}\n              getInitials={getInitials}\n              isRemoving={removeMember.isPending}\n            />\n          ))\n        )}\n      </CardContent>\n    </Card>\n  )\n}\n\ninterface MemberItemProps {\n  member: ConversationMemberWithUser\n  currentUserId?: string\n  isCurrentUserAdmin: boolean\n  onRemove: (memberId: number, memberName: string) => void\n  getInitials: (name: string | undefined, email: string) => string\n  isRemoving: boolean\n}\n\nfunction MemberItem({ \n  member, \n  currentUserId, \n  isCurrentUserAdmin, \n  onRemove, \n  getInitials,\n  isRemoving \n}: MemberItemProps) {\n  const isCurrentUser = member.user_id === currentUserId\n  const memberName = member.user.user_metadata?.full_name || member.user.email\n\n  return (\n    <div className=\"flex items-center justify-between\">\n      <div className=\"flex items-center space-x-3\">\n        <Avatar className=\"h-10 w-10\">\n          <AvatarImage src={member.user.user_metadata?.avatar_url} />\n          <AvatarFallback className=\"bg-primary text-primary-foreground text-sm\">\n            {getInitials(member.user.user_metadata?.full_name, member.user.email)}\n          </AvatarFallback>\n        </Avatar>\n        <div>\n          <div className=\"flex items-center space-x-2\">\n            <span className=\"font-medium text-sm\">\n              {memberName}\n              {isCurrentUser && (\n                <span className=\"text-muted-foreground ml-1\">(You)</span>\n              )}\n            </span>\n            <Badge \n              variant={member.role === 'admin' ? 'default' : 'secondary'} \n              className=\"text-xs\"\n            >\n              {member.role === 'admin' ? (\n                <><Crown className=\"h-3 w-3 mr-1\" /> Admin</>\n              ) : (\n                <><User className=\"h-3 w-3 mr-1\" /> Member</>\n              )}\n            </Badge>\n          </div>\n          <p className=\"text-xs text-muted-foreground\">{member.user.email}</p>\n        </div>\n      </div>\n      \n      {(isCurrentUserAdmin && !isCurrentUser) && (\n        <DropdownMenu>\n          <DropdownMenuTrigger asChild>\n            <Button variant=\"ghost\" size=\"sm\" disabled={isRemoving}>\n              <MoreVertical className=\"h-4 w-4\" />\n            </Button>\n          </DropdownMenuTrigger>\n          <DropdownMenuContent align=\"end\">\n            <DropdownMenuItem \n              onClick={() => onRemove(member.id, memberName)}\n              className=\"text-red-600\"\n            >\n              <UserMinus className=\"h-4 w-4 mr-2\" />\n              Remove Member\n            </DropdownMenuItem>\n          </DropdownMenuContent>\n        </DropdownMenu>\n      )}\n      \n      {isCurrentUser && members?.length > 1 && (\n        <Button \n          variant=\"ghost\" \n          size=\"sm\" \n          onClick={() => onRemove(member.id, 'yourself')}\n          disabled={isRemoving}\n          className=\"text-red-600 hover:text-red-700\"\n        >\n          <UserMinus className=\"h-4 w-4 mr-1\" />\n          Leave\n        </Button>\n      )}\n    </div>\n  )\n}